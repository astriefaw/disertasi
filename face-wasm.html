<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Face Detection Benchmark - WebAssembly</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 20px auto;
      line-height: 1.5;
    }
    #log {
      white-space: pre-wrap;
      background: #f5f5f5;
      padding: 10px;
      border-radius: 4px;
      max-height: 250px;
      overflow-y: auto;
      font-size: 13px;
    }
    img {
      max-width: 300px;
      display: block;
      margin-bottom: 10px;
    }
    label {
      font-size: 14px;
    }
    #status {
      font-size: 14px;
      color: #555;
    }
  </style>
</head>
<body>
  <h1>Face Detection Benchmark - WebAssembly</h1>

  <p>
    Halaman ini digunakan untuk mengukur waktu eksekusi algoritma face detection
    yang diimplementasikan dengan <strong>WebAssembly</strong>.
    Input dan gambar uji harus sama dengan versi JavaScript agar komparasi valid.
  </p>

  <p id="status">Status: loading WebAssembly module...</p>

  <img id="test-image" src="test-face.jpg" alt="Test face image">

  <div>
    <label for="iterations">Iterations: </label>
    <input type="number" id="iterations" value="10" min="1" max="1000">
    <button id="run-btn" disabled>Run Benchmark (WASM)</button>
  </div>

  <h3>Hasil</h3>
  <p id="summary">Belum ada pengujian.</p>
  <div id="log"></div>

  <script>
    // ============================================
    // 1. Inisialisasi modul WebAssembly
    // ============================================
    let wasmInstance = null;

    // importObject bergantung pada modul WASM Anda
    const importObject = {
      env: {
        // Contoh: jika modul perlu fungsi log
        // log_i32: (x) => console.log("log_i32 from WASM:", x)
      }
    };

    async function initWasm() {
      try {
        const response = await WebAssembly.instantiateStreaming(
          fetch("face_detector.wasm"),
          importObject
        );
        wasmInstance = response.instance;

        document.getElementById('status').textContent =
          "Status: WebAssembly module loaded.";
        document.getElementById('run-btn').disabled = false;

        console.log("WASM exports:", wasmInstance.exports);
      } catch (err) {
        console.error("Error loading WASM:", err);
        document.getElementById('status').textContent =
          "Status: gagal memuat WebAssembly. Cek console.";
      }
    }

    // ============================================
    // 2. Fungsi helper untuk mengambil pixel image
    //    dan (opsional) mengirim ke memory WASM
    // ============================================
    function getImageDataFromImg(imgEl) {
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');

      canvas.width = imgEl.naturalWidth || imgEl.width;
      canvas.height = imgEl.naturalHeight || imgEl.height;

      ctx.drawImage(imgEl, 0, 0);
      return ctx.getImageData(0, 0, canvas.width, canvas.height);
    }

    // ============================================
    // 3. Fungsi face detection WASM
    // ============================================
    /**
     * TODO: Sesuaikan bagian ini dengan cara modul WASM Anda bekerja.
     * Pola umum:
     *   1. Ambil ImageData dari canvas
     *   2. Copy pixel ke linear memory WASM
     *   3. Panggil fungsi ekspor WASM, misalnya "detect_face(ptr, width, height)"
     *   4. Ambil hasil (misal jumlah wajah terdeteksi)
     */
    async function detectFaceWasm(imageElement) {
      if (!wasmInstance) {
        throw new Error("WASM belum terinisialisasi");
      }

      // ====== GANTI BAGIAN INI DENGAN IMPLEMENTASI SEBENARNYA ======
      const imageData = getImageDataFromImg(imageElement);
      const width = imageData.width;
      const height = imageData.height;
      const pixels = imageData.data; // Uint8ClampedArray RGBA

      // Contoh pseudo-code: asumsi WASM punya:
      //   - memory: WebAssembly.Memory
      //   - alloc(size): mengembalikan pointer
      //   - free(ptr): membebaskan
      //   - detect_face(ptr, width, height) -> jumlah wajah
      const {
        memory,
        alloc,
        free,
        detect_face
      } = wasmInstance.exports;

      const byteLength = pixels.byteLength;
      const ptr = alloc(byteLength);

      const wasmBytes = new Uint8Array(memory.buffer, ptr, byteLength);
      wasmBytes.set(pixels);

      // Panggil fungsi deteksi
      const faces = detect_face(ptr, width, height);

      // Bebaskan memory kalau perlu
      if (typeof free === 'function') {
        free(ptr);
      }

      return { faces };
      // =============================================================
    }

    // ============================================
    // 4. Fungsi benchmarking
    // ============================================
    async function runBenchmarkWasm() {
      const img = document.getElementById('test-image');
      const iterInput = document.getElementById('iterations');
      const iterations = parseInt(iterInput.value, 10) || 1;

      const logEl = document.getElementById('log');
      const summaryEl = document.getElementById('summary');

      logEl.textContent = "Running WebAssembly benchmark...\n";
      console.log("===== WebAssembly Face Detection Benchmark =====");

      const times = [];

      for (let i = 0; i < iterations; i++) {
        const t0 = performance.now();
        const result = await detectFaceWasm(img);
        const t1 = performance.now();
        const execTime = t1 - t0;

        times.push(execTime);

        const line = `Iterasi ${i + 1}: ${execTime.toFixed(2)} ms, faces = ${result.faces}\n`;
        logEl.textContent += line;
        console.log(line.trim());
      }

      const sum = times.reduce((a, b) => a + b, 0);
      const avg = sum / times.length;
      const min = Math.min(...times);
      const max = Math.max(...times);

      const summaryText =
        `WebAssembly - Iterations: ${iterations}\n` +
        `Rata-rata: ${avg.toFixed(2)} ms\n` +
        `Min: ${min.toFixed(2)} ms, Max: ${max.toFixed(2)} ms`;

      summaryEl.textContent = summaryText;
      logEl.textContent += "\n" + summaryText + "\n";

      console.table(times.map((t, idx) => ({
        iteration: idx + 1,
        time_ms: t
      })));
    }

    // ============================================
    // 5. Event binding & init
    // ============================================
    document.getElementById('run-btn').addEventListener('click', () => {
      runBenchmarkWasm().catch(err => {
        console.error(err);
        document.getElementById('log').textContent += "\nError: " + err.message;
      });
    });

    // Inisialisasi WASM saat halaman load
    window.onload = () => {
      initWasm();
    };
  </script>
</body>
</html>
